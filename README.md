# simple_socks5_ipv4

Минималистичный SOCKS5-прокси на Go с поддержкой **TCP CONNECT** и **UDP ASSOCIATE** (реле UDP-пакетов). Реализован **только IPv4**, без аутентификации и без дополнительных зависимостей — один небольшой бинарник, который пишет логи в stdout.

> Подходит как учебный пример или как легковесный служебный прокси в изолированных/доверенных сетях. Для публичных/боевых сценариев требуется доработка безопасности.

---

## Возможности

- SOCKS5-рукопожатие и выбор метода `NO AUTH` (0x00).
- Команда **CONNECT** (TCP): прозрачный туннель клиент↔цель с двусторонней прокачкой.
- Команда **UDP ASSOCIATE**: приём UDP-датаграмм от клиента и форвард на целевой хост/порт с ответным реле обратно клиенту.
- **Idle-таймаут** на чтение в обеих сторонах канала (TCP и UDP) с авто-закрытием соединений.
- TCP keep-alive для клиентских и целевых подключений.
- Логи с указанием удалённого клиента и целевого направления.

## Ограничения/оговорки

- **IPv4-only**: используется `tcp4/udp4`. IPv6 не поддерживается.
- **Без аутентификации**: метод всегда `NO AUTH`. Доступ контролируйте внешними средствами (фаервол, ACL, сетевые политики).
- **Без DNS-резолвера на стороне прокси**: доменные имена поддерживаются в протоколе SOCKS5 (ATYP=0x03), но резолвинг выполняется стандартными средствами `net.Dial` для целевого адреса.
- **Минимальная совместимость**: нацелено на базовые клиенты SOCKS5. Команды кроме CONNECT/UDP ASSOCIATE не поддерживаются.
- **UDP**: реализовано реле датаграмм по RFC 1928/1929 без фрагментации (FRAG≠0 игнорируется).

## Переменные окружения

- `PORT` — TCP-порт прослушивания (по умолчанию `1080`).
- `IDLE_TIMEOUT` — секунд до таймаута простоя на чтение (по умолчанию `5`).  
  Неверные/неположительные значения игнорируются, берётся 5 сек.

Пример:
```bash
export PORT=1080
export IDLE_TIMEOUT=30
```

## Сборка

Требуется Go 1.19+.

```bash
go build -o simple_socks5_ipv4 ./simple_socks5_ipv4.go
```

## Запуск

```bash
# по умолчанию слушает 0.0.0.0:1080
./simple_socks5_ipv4

# с кастомными параметрами
PORT=1080 IDLE_TIMEOUT=20 ./simple_socks5_ipv4
```

Логи примера:
```
[CONFIG] Idle timeout = 20s
SOCKS5 IPv4-only proxy on 0.0.0.0:1080 (idle timeout 20s)
[SOCKS5] new from 192.0.2.10:54321
[SOCKS5] [192.0.2.10:54321] CONNECT → 93.184.216.34:80
```

## Быстрая проверка

### TCP (CONNECT)
```bash
# HTTP-запрос через SOCKS5
curl --socks5-hostname 127.0.0.1:1080 https://example.com -I
```

### UDP (ASSOCIATE)
Проверьте с клиентом, поддерживающим SOCKS5 UDP (например, некоторые сетевые инструменты/браузеры с расширениями). Сервер по команде `UDP ASSOCIATE` выдаёт адрес/порт локального UDP-сокета, через который релеятся пакеты.

## Архитектура/поведение

- При CONNECT создаются два горутино-насоса (client→target и target→client). На каждом чтении выставляется `ReadDeadline = now + IDLE_TIMEOUT`. Любая ошибка/таймаут закрывает туннель.
- При UDP ASSOCIATE поднимается локальный `UDPConn` на эпемерном порту; для каждой входящей датаграммы создаётся одноразовое соединение к удалённому `UDPAddr`, выполняется одно чтение ответа (с таймаутом), затем ответ упаковывается в SOCKS5-UDP-формат и отправляется клиенту.

## Безопасность

- Добавьте контроль доступа на уровне OS/сети (iptables/nftables, firewalld, security groups, TPROXY/REDIRECT и т.д.).
- Изолируйте сервис (systemd `DynamicUser`, `ProtectSystem`, `PrivateTmp`, `NoNewPrivileges`, Docker/Podman rootless и т.п.).
- Для интернета/публичного использования стоит внедрить:
  - аутентификацию (RFC 1929), 
  - списки разрешённых подсетей/хостов,
  - лимиты сессий/скорости, 
  - мониторинг и алерты.

## Пример unit-файла systemd

```ini
[Unit]
Description=Simple SOCKS5 IPv4 Proxy
After=network-online.target
Wants=network-online.target

[Service]
ExecStart=/opt/socks5/simple_socks5_ipv4
Environment=PORT=1080
Environment=IDLE_TIMEOUT=20
Restart=on-failure
AmbientCapabilities=
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
WorkingDirectory=/opt/socks5
User=nobody
Group=nogroup

[Install]
WantedBy=multi-user.target
```

### Дисклеймер
Этот репозиторий демонстрирует базовую реализацию SOCKS5. Автор(ы) не несут ответственности за возможный ущерб при неправильной эксплуатации. Перед развёртыванием в продакшн внимательно оцените риски и укрепите безопасность.
